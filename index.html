<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C-Lang Practice AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root {
            --primary: #1a73e8;
            --success: #34a853;
            --warning: #fbbc04;
            --danger: #ea4335;
            --bg-body: #f8f9fa;
            --bg-card: #ffffff;
            --text-main: #202124;
            --text-sub: #5f6368;
            --border: #dadce0;
            --code-bg: #1e1e1e;
            --code-text: #d4d4d4;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
            line-height: 1.6;
        }

        .container { max-width: 900px; margin: 0 auto; }

        header { text-align: center; margin-bottom: 40px; }
        h1 {
            font-size: 1.8rem; margin: 0;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .subtitle { color: var(--text-sub); font-size: 0.9rem; margin-top: 5px; }

        /* Card */
        .card {
            background-color: var(--bg-card);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        .form-row {
            display: flex; gap: 20px; margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .form-group { flex: 1; min-width: 200px; }
        
        label {
            display: flex; justify-content: space-between; align-items: center;
            font-weight: 700; font-size: 0.85rem;
            margin-bottom: 8px; color: var(--text-sub);
        }
        
        .label-links a {
            color: var(--primary); text-decoration: none; font-weight: normal; margin-left: 10px;
            font-size: 0.8rem; display: inline-flex; align-items: center; gap: 2px;
        }
        .label-links a:hover { text-decoration: underline; }

        input, select {
            width: 100%; padding: 12px;
            border: 1px solid var(--border); border-radius: 8px;
            font-size: 1rem; background: #fff;
            appearance: none;
        }
        select {
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' height='24' viewBox='0 0 24 24' width='24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
        }

        /* Common Accordion Styles */
        .accordion-wrapper {
            margin-bottom: 15px;
            border: 1px solid #e0e0e0; border-radius: 12px; overflow: hidden; background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .accordion-header {
            padding: 15px 20px; background: #f8f9fa; color: var(--text-main); font-weight: 700;
            cursor: pointer; display: flex; align-items: center; justify-content: space-between;
            transition: background 0.2s; user-select: none;
        }
        .accordion-header:hover { background: #f1f3f4; }
        .accordion-content {
            max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; background: #fff;
        }
        .accordion-body { padding: 25px; color: var(--text-main); font-size: 0.95rem; border-top: 1px solid #f0f0f0; }

        /* Specific Header Colors */
        .header-exp { background: #e8f0fe; color: var(--primary); }
        .header-exp:hover { background: #dce8fd; }
        
        .header-feedback { background: #fff8e1; color: #b08800; }
        .header-feedback:hover { background: #ffecb3; }

        .header-model { background: #e6f4ea; color: var(--success); }
        .header-model:hover { background: #ceead6; }

        .topic-title { font-size: 1.1rem; font-weight: bold; border-bottom: 2px solid var(--primary); padding-bottom: 8px; margin-bottom: 15px; display: inline-block; }
        .topic-subtitle { font-weight: bold; margin-top: 15px; margin-bottom: 5px; color: #444; display: flex; align-items: center; gap: 5px; }
        .exp-code { background: #f4f4f4; padding: 10px; border-radius: 6px; font-family: 'Roboto Mono', monospace; font-size: 0.9rem; color: #333; border: 1px solid #ddd; margin: 5px 0; overflow-x: auto; }
        .exp-list { padding-left: 20px; margin: 5px 0 15px 0; }
        .exp-list li { margin-bottom: 5px; }

        /* Question Area */
        #question-area {
            background: #e8f0fe; color: #174ea6;
            padding: 20px; border-radius: 8px;
            border-left: 5px solid var(--primary);
            margin-bottom: 20px; display: none;
        }
        .q-label { font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; display: block; opacity: 0.7; }
        .q-text { font-size: 1.1rem; font-weight: 700; margin-bottom: 10px;}
        .q-desc { font-size: 0.95rem; color: #3c4043; white-space: pre-wrap; }

        /* Code Editor */
        .editor-wrapper { position: relative; margin-bottom: 20px; }
        textarea#code-editor {
            width: 100%; height: 400px;
            background-color: var(--code-bg); color: var(--code-text);
            font-family: 'Roboto Mono', monospace; font-size: 14px;
            padding: 35px 20px 20px 20px; border-radius: 8px; border: none;
            resize: vertical; tab-size: 4; outline: none; line-height: 1.5;
        }
        .editor-header {
            position: absolute; top: 0; left: 0; right: 0;
            background: #333; color: #aaa;
            padding: 5px 15px; border-radius: 8px 8px 0 0;
            font-size: 0.75rem; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
        }
        .run-link { color: #4caf50; text-decoration: none; display: flex; align-items: center; gap: 4px; }
        .run-link:hover { text-decoration: underline; color: #81c784; }

        /* Buttons */
        .btn {
            width: 100%; padding: 15px; border: none; border-radius: 50px;
            font-size: 1rem; font-weight: 700; cursor: pointer; transition: opacity 0.2s;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-primary { background-color: var(--text-main); color: #fff; }
        .btn-accent { background-color: var(--primary); color: #fff; }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { background-color: #bdc1c6; cursor: not-allowed; }

        /* Result Area */
        #result-area { display: none; margin-top: 30px; animation: fadeIn 0.5s ease; }
        
        .score-card {
            text-align: center; margin-bottom: 20px; padding: 20px;
            border-radius: 12px; border: 2px solid transparent;
            background: #fff;
        }
        .score-card.high { border-color: var(--success); background-color: #e6f4ea; color: var(--success); }
        .score-card.mid { border-color: var(--warning); background-color: #fef7e0; color: #b08800; }
        .score-card.low { border-color: var(--danger); background-color: #fce8e6; color: var(--danger); }

        .score-title { font-weight: bold; font-size: 1rem; letter-spacing: 0.05em; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .score-value { font-size: 3.5rem; font-weight: 800; line-height: 1; margin: 10px 0; }
        .score-max { font-size: 1.5rem; opacity: 0.6; font-weight: 600; }

        /* Feedback Content Styles */
        .fb-content { line-height: 1.8; font-size: 0.95rem; }
        .fb-content ul { padding-left: 20px; margin: 10px 0; }
        .fb-content li { margin-bottom: 5px; }
        .fb-content strong { background: linear-gradient(transparent 60%, #fff176 60%); }

        pre { background: #2d2d2d; color: #ccc; padding: 15px; border-radius: 8px; overflow-x: auto; font-family: 'Roboto Mono', monospace; font-size: 0.9rem; margin: 0; }

        .loader {
            width: 20px; height: 20px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%;
            animation: spin 1s linear infinite; display: none;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none; }
        .error-msg { color: #d93025; background: #fce8e6; padding: 10px; border-radius: 8px; font-size: 0.9rem; margin-top: 10px; display: none; }
        
        .retry-note {
            text-align: center; font-size: 0.85rem; color: var(--text-sub); margin-top: 10px;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1><span class="material-icons-round" style="color:var(--primary);">code</span> C-Lang Practice AI</h1>
        <div class="subtitle">æƒ…å ±å‡¦ç†II è¬›ç¾©å¯¾å¿œãƒ»æ¼”ç¿’ã‚·ã‚¹ãƒ†ãƒ </div>
    </header>

    <div class="card">
        <div class="form-group" style="margin-bottom: 20px;">
            <label>
                API Key (Google Gemini)
                <div class="label-links">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank">
                        <span class="material-icons-round" style="font-size:16px;">open_in_new</span> Google AI Studio
                    </a>
                    <a href="help.html" target="_blank">
                        <span class="material-icons-round" style="font-size:16px;">help_outline</span> å–å¾—æ–¹æ³•ãƒ»è§£èª¬
                    </a>
                </div>
            </label>
            <input type="password" id="apiKey" placeholder="Alza... (APIã‚­ãƒ¼ã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘)">
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>å­¦ç¿’å˜å…ƒ</label>
                <select id="genre" onchange="updateExplanation()">
                    <option value="topic1">1. ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®åŸºç¤ (å¤‰æ•°, è¨ˆç®—, å…¥å‡ºåŠ›)</option>
                    <option value="topic2">2. æ¡ä»¶åˆ†å² (if, switch)</option>
                    <option value="topic3">3. ç¹°ã‚Šè¿”ã— (while, for, do-while)</option>
                    <option value="topic4">4. é–¢æ•° (å®šç¾©, å¼•æ•°, æˆ»ã‚Šå€¤)</option>
                    <option value="topic5">5. å†å¸°é–¢æ•° (éšä¹—, ãƒ•ã‚£ãƒœãƒŠãƒƒãƒ)</option>
                    <option value="topic6">6. é…åˆ— (1æ¬¡å…ƒãƒ»2æ¬¡å…ƒ, ã‚½ãƒ¼ãƒˆ)</option>
                    <option value="topic7">7. æ–‡å­—ã¨æ–‡å­—åˆ— (charé…åˆ—, ASCII)</option>
                    <option value="topic8">8. ãƒã‚¤ãƒ³ã‚¿ (ã‚¢ãƒ‰ãƒ¬ã‚¹, å‚ç…§æ¸¡ã—)</option>
                </select>
            </div>
            <div class="form-group">
                <label>é›£æ˜“åº¦</label>
                <select id="difficulty">
                    <option value="åŸºç¤">ğŸ”° åŸºç¤ (æ–‡æ³•ç¢ºèª)</option>
                    <option value="æ¨™æº–">ğŸ’» æ¨™æº– (æˆæ¥­ã®æ¼”ç¿’ãƒ¬ãƒ™ãƒ«)</option>
                    <option value="å¿œç”¨">ğŸ”¥ å¿œç”¨ (ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å¿œç”¨)</option>
                </select>
            </div>
        </div>

        <div class="accordion-wrapper">
            <div class="accordion-header header-exp" onclick="toggleAccordion('exp-content', 'exp-icon')">
                <span style="display:flex; align-items:center; gap:8px;">
                    <span class="material-icons-round">lightbulb</span>
                    <span id="exp-header-text">1. ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®åŸºç¤ ã®ãƒã‚¤ãƒ³ãƒˆ</span>
                </span>
                <span class="material-icons-round" id="exp-icon">expand_more</span>
            </div>
            <div class="accordion-content" id="exp-content">
                <div class="accordion-body" id="exp-body"></div>
            </div>
        </div>

        <button id="btn-start" class="btn btn-primary" onclick="generateProblem()">
            <span>å•é¡Œã‚’ä½œæˆã™ã‚‹</span>
            <div class="loader" id="loader-start"></div>
        </button>
        <div id="errorMsg" class="error-msg"></div>
    </div>

    <div id="exercise-section" class="hidden">
        <div class="card">
            <div id="question-area">
                <span class="q-label">QUESTION</span>
                <div id="q-title" class="q-text"></div>
                <div id="q-desc" class="q-desc"></div>
            </div>

            <div class="editor-wrapper">
                <div class="editor-header">
                    <span>main.c</span>
                    <a href="https://paiza.io/ja/languages/c" target="_blank" class="run-link">
                        <span class="material-icons-round" style="font-size:14px;">open_in_new</span>
                        ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ³ãƒ‘ã‚¤ãƒ© (Paiza.IO)
                    </a>
                </div>
                <textarea id="code-editor" spellcheck="false">
#include <stdio.h>

int main(void) {
    // ã“ã“ã«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ãã ã•ã„
    
    return 0;
}</textarea>
            </div>

            <button id="btn-submit" class="btn btn-accent" onclick="submitCode()">
                <span>æå‡ºã—ã¦æ¡ç‚¹</span>
                <div class="loader" id="loader-submit"></div>
            </button>
            <div class="retry-note">â€» ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦ä½•åº¦ã§ã‚‚å†æå‡ºã§ãã¾ã™</div>
        </div>
    </div>

    <div id="result-area" class="card">
        <div class="score-card" id="score-card">
            <div class="score-title" id="score-title">
                <span class="material-icons-round">analytics</span> æ¡ç‚¹çµæœ
            </div>
            <div class="score-value">
                <span id="res-score">--</span><span class="score-max">/ 100</span>
            </div>
        </div>

        <div class="accordion-wrapper">
            <div class="accordion-header header-feedback" onclick="toggleAccordion('fb-content', 'fb-icon')">
                <span style="display:flex; align-items:center; gap:8px;">
                    <span class="material-icons-round" style="color:#f9a825;">lightbulb</span>
                    <span>AIã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</span>
                </span>
                <span class="material-icons-round" id="fb-icon">expand_more</span>
            </div>
            <div class="accordion-content" id="fb-content">
                <div class="accordion-body fb-content" id="res-feedback"></div>
            </div>
        </div>

        <div class="accordion-wrapper">
            <div class="accordion-header header-model" onclick="toggleAccordion('model-content', 'model-icon')">
                <span style="display:flex; align-items:center; gap:8px;">
                    <span class="material-icons-round" style="color:#34a853;">code</span>
                    <span>æ¨¡ç¯„è§£ç­”ä¾‹ã‚’è¡¨ç¤º</span>
                </span>
                <span class="material-icons-round" id="model-icon">expand_more</span>
            </div>
            <div class="accordion-content" id="model-content">
                <div class="accordion-body" style="padding:0;">
                    <div id="res-model-code"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- è§£èª¬ãƒ‡ãƒ¼ã‚¿ ---
    const topicExplanations = {
        "topic1": `
            <div class="topic-title">ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®åŸºæœ¬æ§‹é€ ã¨å¤‰æ•°</div>
            <div class="topic-subtitle"><span class="material-icons-round" style="font-size:18px;">menu_book</span> åŸºæœ¬æ§‹æ–‡</div>
            <p>Cè¨€èªã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã¯ <code>main</code> é–¢æ•°ã‹ã‚‰å§‹ã¾ã‚Šã¾ã™ã€‚å¤‰æ•°ã¯ä½¿ç”¨ã™ã‚‹å‰ã«å®£è¨€ãŒå¿…è¦ã§ã™ã€‚</p>
            <div class="exp-code">#include &lt;stdio.h&gt;\n\nint main(void) {\n    int a;       // æ•´æ•°å‹å¤‰æ•°ã®å®£è¨€\n    a = 10;      // ä»£å…¥\n    printf("a = %d\\n", a); // è¡¨ç¤º\n    return 0;\n}</div>
            <div class="topic-subtitle"><span class="material-icons-round" style="font-size:18px;">calculate</span> è¨ˆç®—ã¨å‹</div>
            <ul class="exp-list">
                <li><strong>int</strong>: æ•´æ•°ã€‚å‰²ã‚Šç®— <code>5/2</code> ã¯ <code>2</code> (åˆ‡ã‚Šæ¨ã¦) ã«ãªã‚‹ã®ã§æ³¨æ„ã€‚</li>
                <li><strong>float</strong>: å®Ÿæ•°ã€‚å…¥å‡ºåŠ›ã«ã¯ <code>%f</code> ã‚’ä½¿ã†ã€‚</li>
                <li><strong>scanf</strong>: å…¥åŠ›ã«ã¯ <code>&</code> ãŒå¿…è¦ã€‚ä¾‹: <code>scanf("%d", &a);</code></li>
            </ul>`,
        "topic2": `<div class="topic-title">æ¡ä»¶åˆ†å²</div><p>ifæ–‡ã‚„switchæ–‡ã‚’ä½¿ã£ã¦å‡¦ç†ã‚’åˆ†ã‘ã¾ã™ã€‚switchæ–‡ã§ã¯ <code>break</code> ã‚’å¿˜ã‚Œãªã„ã‚ˆã†ã«ã€‚</p>`,
        "topic3": `<div class="topic-title">ç¹°ã‚Šè¿”ã—å‡¦ç†</div><p>å›æ•°ãŒæ±ºã¾ã£ã¦ã„ã‚‹ãªã‚‰ <code>for</code>ã€æ¡ä»¶ã§ç¹°ã‚Šè¿”ã™ãªã‚‰ <code>while</code> ã‚’ä½¿ã„ã¾ã™ã€‚</p>`,
        "topic4": `<div class="topic-title">é–¢æ•°</div><p>å‡¦ç†ã‚’éƒ¨å“åŒ–ã—ã¾ã™ã€‚ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—å®£è¨€ã‚’å¿˜ã‚Œãšã«ã€‚</p>`,
        "topic5": `<div class="topic-title">å†å¸°é–¢æ•°</div><p>é–¢æ•°å†…ã§è‡ªåˆ†è‡ªèº«ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚å¿…ãšçµ‚äº†æ¡ä»¶ï¼ˆãƒ™ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ï¼‰ãŒå¿…è¦ã§ã™ã€‚</p>`,
        "topic6": `<div class="topic-title">é…åˆ—</div><p>åŒã˜å‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã¾ã¨ã‚ã¦æ‰±ã„ã¾ã™ã€‚æ·»å­—ã¯0ã‹ã‚‰å§‹ã¾ã‚Šã¾ã™ã€‚</p>`,
        "topic7": `<div class="topic-title">æ–‡å­—ã¨æ–‡å­—åˆ—</div><p>æ–‡å­—åˆ—ã¯ <code>char</code> å‹ã®é…åˆ—ã§ã™ã€‚æœ«å°¾ã«ã¯ <code>\\0</code> ãŒå…¥ã‚Šã¾ã™ã€‚</p>`,
        "topic8": `<div class="topic-title">ãƒã‚¤ãƒ³ã‚¿</div><p>å¤‰æ•°ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ‰±ã„ã¾ã™ã€‚<code>&a</code> ã§ã‚¢ãƒ‰ãƒ¬ã‚¹å–å¾—ã€<code>*p</code> ã§ä¸­èº«ã‚’å‚ç…§ã—ã¾ã™ã€‚</p>`
    };

    const courseContext = {
        "topic1": `ã€å˜å…ƒ1: å¤‰æ•°ã¨è¨ˆç®—ã€‘ - å¿…é ˆ: int, float, printf, scanf, å››å‰‡æ¼”ç®— - æ¼”ç¿’: ç·å’Œ, ç©, å‰°ä½™`,
        "topic2": `ã€å˜å…ƒ2: æ¡ä»¶åˆ†å²ã€‘ - å¿…é ˆ: if, switch - æ¼”ç¿’: æ­£è² åˆ¤å®š, è§£ã®å€‹æ•°`,
        "topic3": `ã€å˜å…ƒ3: ç¹°ã‚Šè¿”ã—ã€‘ - å¿…é ˆ: for, while - æ¼”ç¿’: 1ã‹ã‚‰Nã®å’Œ, ä¹ä¹, å…¥åŠ›ãƒã‚§ãƒƒã‚¯`,
        "topic4": `ã€å˜å…ƒ4: é–¢æ•°ã€‘ - å¿…é ˆ: é–¢æ•°å®šç¾©, å¼•æ•° - æ¼”ç¿’: éšä¹—, ç´¯ä¹—, çµ„ã¿åˆã‚ã›`,
        "topic5": `ã€å˜å…ƒ5: å†å¸°é–¢æ•°ã€‘ - å¿…é ˆ: å†å¸°å‘¼ã³å‡ºã— - æ¼”ç¿’: éšä¹—, ãƒ•ã‚£ãƒœãƒŠãƒƒãƒ, ãƒãƒã‚¤`,
        "topic6": `ã€å˜å…ƒ6: é…åˆ—ã€‘ - å¿…é ˆ: é…åˆ—, 2æ¬¡å…ƒé…åˆ— - æ¼”ç¿’: æœ€å¤§æœ€å°, ã‚½ãƒ¼ãƒˆ, è¡Œåˆ—`,
        "topic7": `ã€å˜å…ƒ7: æ–‡å­—ã¨æ–‡å­—åˆ—ã€‘ - å¿…é ˆ: charé…åˆ—, æ–‡å­—åˆ—æ“ä½œ - æ¼”ç¿’: å›æ–‡, é€£çµ, æ¤œç´¢`,
        "topic8": `ã€å˜å…ƒ8: ãƒã‚¤ãƒ³ã‚¿ã€‘ - å¿…é ˆ: ã‚¢ãƒ‰ãƒ¬ã‚¹, å‚ç…§æ¸¡ã— - æ¼”ç¿’: swapé–¢æ•°, é…åˆ—æ“ä½œ`
    };

    // --- UI Logic ---
    function updateExplanation() {
        const genre = document.getElementById('genre').value;
        const select = document.getElementById('genre');
        const text = select.options[select.selectedIndex].text;
        document.getElementById('exp-header-text').innerText = text + " ã®ãƒã‚¤ãƒ³ãƒˆ";
        document.getElementById('exp-body').innerHTML = topicExplanations[genre];
        openAccordion('exp-content', 'exp-icon');
    }

    // æ±ç”¨ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰
    function toggleAccordion(contentId, iconId) {
        const content = document.getElementById(contentId);
        const icon = document.getElementById(iconId);
        if (content.style.maxHeight) {
            content.style.maxHeight = null;
            icon.style.transform = "rotate(0deg)";
        } else {
            content.style.maxHeight = content.scrollHeight + "px";
            icon.style.transform = "rotate(180deg)";
        }
    }

    function openAccordion(contentId, iconId) {
        const content = document.getElementById(contentId);
        const icon = document.getElementById(iconId);
        content.style.maxHeight = content.scrollHeight + "px";
        icon.style.transform = "rotate(180deg)";
    }

    function closeAccordion(contentId, iconId) {
        const content = document.getElementById(contentId);
        const icon = document.getElementById(iconId);
        content.style.maxHeight = null;
        icon.style.transform = "rotate(0deg)";
    }

    window.onload = function() {
        updateExplanation();
    };

    // --- Gemini API Logic ---
    async function findWorkingModel(apiKey) {
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            const models = data.models || [];
            const validModel = models.find(m => m.name.includes("flash")) 
                            || models.find(m => m.name.includes("pro"))
                            || models.find(m => m.supportedGenerationMethods.includes("generateContent"));
            if (!validModel) throw new Error("åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            return validModel.name.replace('models/', '');
        } catch (e) {
            return "gemini-1.5-flash"; 
        }
    }

    async function generateProblem() {
        const apiKey = document.getElementById('apiKey').value.trim();
        const genreKey = document.getElementById('genre').value;
        const diff = document.getElementById('difficulty').value;
        const errBox = document.getElementById('errorMsg');

        if (!apiKey) {
            errBox.style.display = 'block';
            errBox.innerText = "APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
            return;
        }
        errBox.style.display = 'none';

        uiState('loading-start');

        try {
            const model = await findWorkingModel(apiKey);
            const contextInfo = courseContext[genreKey];

            const prompt = `
ã‚ãªãŸã¯å¤§å­¦ã®ã€Œæƒ…å ±å‡¦ç†II (Cè¨€èª)ã€ã®æ¼”ç¿’ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚
ä»¥ä¸‹ã®è¬›ç¾©ãƒ»æ¼”ç¿’ç¯„å›²ã«åŸºã¥ã„ã¦ã€å­¦ç”Ÿå‘ã‘ã®æ¼”ç¿’å•é¡Œã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€å­¦ç¿’ç¯„å›²æƒ…å ±ã€‘
${contextInfo}

ã€é›£æ˜“åº¦ã€‘
${diff}

ã€å‡ºåŠ›ãƒ«ãƒ¼ãƒ«ã€‘
ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆMarkdownè¨˜æ³•ã¯ä¸è¦ï¼‰ã€‚
{
  "title": "å•é¡Œã®ã‚¿ã‚¤ãƒˆãƒ«",
  "description": "å•é¡Œæ–‡ã€‚å®Ÿè£…å†…å®¹ã€å…¥åŠ›ä¾‹ã€å‡ºåŠ›ä¾‹ã‚’å…·ä½“çš„ã«è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚",
  "template": "åˆæœŸã‚³ãƒ¼ãƒ‰ï¼ˆ#include <stdio.h> int main(void){ ... } ç¨‹åº¦ï¼‰"
}`;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            
            if(!res.ok) throw new Error("API Request Failed");

            const data = await res.json();
            const text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
            const json = JSON.parse(text);

            document.getElementById('q-title').innerText = json.title;
            document.getElementById('q-desc').innerText = json.description;
            if(json.template) document.getElementById('code-editor').value = json.template;
            
            // çµæœã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤ºã€ã‚¨ãƒ‡ã‚£ã‚¿ã‚’è¡¨ç¤º
            document.getElementById('exercise-section').style.display = 'block';
            document.getElementById('question-area').style.display = 'block';
            document.getElementById('result-area').style.display = 'none';
            document.getElementById('exercise-section').scrollIntoView({ behavior: 'smooth' });

        } catch (e) {
            errBox.style.display = 'block';
            errBox.innerText = "ã‚¨ãƒ©ãƒ¼: " + e.message + "\nAPIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
        } finally {
            uiState('idle-start');
        }
    }

    async function submitCode() {
        const apiKey = document.getElementById('apiKey').value.trim();
        const genreKey = document.getElementById('genre').value;
        const problemTitle = document.getElementById('q-title').innerText;
        const problemDesc = document.getElementById('q-desc').innerText;
        const userCode = document.getElementById('code-editor').value;
        const errBox = document.getElementById('errorMsg');

        if (!userCode) { alert("ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

        uiState('loading-submit');

        try {
            const model = await findWorkingModel(apiKey);
            const contextInfo = courseContext[genreKey];

            const prompt = `
ã‚ãªãŸã¯Cè¨€èªã®æ¡ç‚¹å®˜ã§ã™ã€‚
ä»¥ä¸‹ã®å•é¡Œã«å¯¾ã™ã‚‹å­¦ç”Ÿã®ã‚³ãƒ¼ãƒ‰ã‚’è©•ä¾¡ãƒ»æ·»å‰Šã—ã¦ãã ã•ã„ã€‚

ã€è¬›ç¾©ã®å‰æçŸ¥è­˜ã€‘
${contextInfo}

ã€å•é¡Œã€‘
${problemTitle}
${problemDesc}

ã€æå‡ºã‚³ãƒ¼ãƒ‰ã€‘
${userCode}

ã€å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‘
ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆMarkdownä¸è¦ï¼‰ã€‚
feedbackãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã¯ã€è¦‹å‡ºã—(<h3>ç­‰)ã€ç®‡æ¡æ›¸ã(<ul><li>ç­‰)ã€å¤ªå­—(<b>)ãªã©ã®HTMLã‚¿ã‚°ã‚’ä½¿ã£ã¦ã€è¦–è¦šçš„ã«ã‚ã‹ã‚Šã‚„ã™ãè¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
{
  "score": ç‚¹æ•°(0-100ã®æ•´æ•°),
  "feedback": "<h3>åˆ¤å®š</h3>... <h3>è‰¯ã‹ã£ãŸç‚¹</h3><ul><li>...</li></ul> <h3>æ”¹å–„ç‚¹ãƒ»è§£èª¬</h3><ul><li>...</li></ul>",
  "corrected_code": "æ¨¡ç¯„è§£ç­”ã¾ãŸã¯ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰ï¼ˆCè¨€èªï¼‰"
}`;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            if(!res.ok) throw new Error("API Request Failed");

            const data = await res.json();
            const text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
            const json = JSON.parse(text);

            // çµæœã®åæ˜ 
            const score = json.score;
            document.getElementById('res-score').innerText = score;
            document.getElementById('res-feedback').innerHTML = json.feedback;
            
            // ã‚¹ã‚³ã‚¢ã‚¹ã‚¿ã‚¤ãƒ«
            const scoreCard = document.getElementById('score-card');
            const scoreTitle = document.getElementById('score-title');
            scoreCard.className = 'score-card'; // Reset
            if (score >= 80) {
                scoreCard.classList.add('high');
                scoreTitle.innerHTML = '<span class="material-icons-round">sentiment_satisfied_alt</span> ç´ æ™´ã‚‰ã—ã„ï¼';
            } else if (score >= 50) {
                scoreCard.classList.add('mid');
                scoreTitle.innerHTML = '<span class="material-icons-round">sentiment_neutral</span> ãŠã—ã„ï¼ã‚ã¨å°‘ã—';
            } else {
                scoreCard.classList.add('low');
                scoreTitle.innerHTML = '<span class="material-icons-round">sentiment_dissatisfied</span> å¾©ç¿’ã—ã¾ã—ã‚‡ã†';
            }

            // æ¨¡ç¯„è§£ç­”ã‚»ãƒƒãƒˆï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ï¼‰
            const escapedCode = json.corrected_code
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
            document.getElementById('res-model-code').innerHTML = `<pre>${escapedCode}</pre>`;

            // ã‚¨ãƒªã‚¢è¡¨ç¤ºã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            document.getElementById('result-area').style.display = 'block';
            
            // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³åˆ¶å¾¡ï¼šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯é–‹ãã€æ¨¡ç¯„è§£ç­”ã¯é–‰ã˜ã‚‹
            openAccordion('fb-content', 'fb-icon');
            closeAccordion('model-content', 'model-icon');

            document.getElementById('result-area').scrollIntoView({ behavior: 'smooth' });

        } catch (e) {
            errBox.style.display = 'block';
            errBox.innerText = "æ¡ç‚¹ã‚¨ãƒ©ãƒ¼: " + e.message;
        } finally {
            uiState('idle-submit');
        }
    }

    document.getElementById('code-editor').addEventListener('keydown', function(e) {
        if (e.key == 'Tab') {
            e.preventDefault();
            var start = this.selectionStart;
            var end = this.selectionEnd;
            this.value = this.value.substring(0, start) + "    " + this.value.substring(end);
            this.selectionStart = this.selectionEnd = start + 4;
        }
    });

    function uiState(state) {
        const startBtn = document.getElementById('btn-start');
        const submitBtn = document.getElementById('btn-submit');
        const lStart = document.getElementById('loader-start');
        const lSubmit = document.getElementById('loader-submit');

        if (state === 'loading-start') {
            startBtn.disabled = true;
            lStart.style.display = 'block';
        } else if (state === 'idle-start') {
            startBtn.disabled = false;
            lStart.style.display = 'none';
        } else if (state === 'loading-submit') {
            submitBtn.disabled = true;
            lSubmit.style.display = 'block';
        } else if (state === 'idle-submit') {
            submitBtn.disabled = false;
            lSubmit.style.display = 'none';
        }
    }
</script>

</body>
</html>
