<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C-Lang Practice AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        :root {
            --primary: #1a73e8;
            --bg-body: #f8f9fa;
            --bg-card: #ffffff;
            --text-main: #202124;
            --text-sub: #5f6368;
            --border: #dadce0;
            --code-bg: #1e1e1e;
            --code-text: #d4d4d4;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 40px 20px;
            line-height: 1.6;
        }

        .container { max-width: 900px; margin: 0 auto; }

        header { text-align: center; margin-bottom: 40px; }
        h1 {
            font-size: 1.8rem; margin: 0;
            display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .subtitle { color: var(--text-sub); font-size: 0.9rem; margin-top: 5px; }

        /* Card */
        .card {
            background-color: var(--bg-card);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        .form-row {
            display: flex; gap: 20px; margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .form-group { flex: 1; min-width: 200px; }
        
        label {
            display: block; font-weight: 700; font-size: 0.85rem;
            margin-bottom: 8px; color: var(--text-sub);
        }
        
        .api-link { float: right; color: var(--primary); text-decoration: none; font-weight: normal; }

        input, select {
            width: 100%; padding: 12px;
            border: 1px solid var(--border); border-radius: 8px;
            font-size: 1rem; background: #fff;
            appearance: none;
        }
        select {
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' height='24' viewBox='0 0 24 24' width='24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
        }

        /* Question Area */
        #question-area {
            background: #e8f0fe; color: #174ea6;
            padding: 20px; border-radius: 8px;
            border-left: 5px solid var(--primary);
            margin-bottom: 20px; display: none;
        }
        .q-label { font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; display: block; opacity: 0.7; }
        .q-text { font-size: 1.1rem; font-weight: 700; margin-bottom: 10px;}
        .q-desc { font-size: 0.95rem; color: #3c4043; white-space: pre-wrap; }

        /* Code Editor */
        .editor-wrapper { position: relative; margin-bottom: 20px; }
        textarea#code-editor {
            width: 100%; height: 400px;
            background-color: var(--code-bg); color: var(--code-text);
            font-family: 'Roboto Mono', monospace; font-size: 14px;
            padding: 35px 20px 20px 20px; border-radius: 8px; border: none;
            resize: vertical; tab-size: 4; outline: none;
            line-height: 1.5;
        }
        .editor-header {
            position: absolute; top: 0; left: 0; right: 0;
            background: #333; color: #aaa;
            padding: 5px 15px; border-radius: 8px 8px 0 0;
            font-size: 0.75rem; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
        }
        .run-link {
            color: #4caf50; text-decoration: none; display: flex; align-items: center; gap: 4px;
        }
        .run-link:hover { text-decoration: underline; color: #81c784; }

        /* Buttons */
        .btn {
            width: 100%; padding: 15px;
            border: none; border-radius: 50px;
            font-size: 1rem; font-weight: 700; cursor: pointer;
            transition: opacity 0.2s;
            display: flex; justify-content: center; align-items: center; gap: 8px;
        }
        .btn-primary { background-color: var(--text-main); color: #fff; }
        .btn-accent { background-color: var(--primary); color: #fff; }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { background-color: #bdc1c6; cursor: not-allowed; }

        /* Result Area */
        #result-area { display: none; margin-top: 30px; animation: fadeIn 0.5s ease; }
        
        .score-box {
            text-align: center; margin-bottom: 20px;
        }
        .score-num { font-size: 3.5rem; font-weight: 800; color: var(--primary); line-height: 1; }
        .score-label { font-size: 1rem; color: var(--text-sub); }

        .feedback-card {
            background: #fafafa; border: 1px solid var(--border);
            border-radius: 12px; padding: 20px; margin-bottom: 20px;
        }
        .fb-title { font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; font-size: 1.05rem; }
        
        pre {
            background: #2d2d2d; color: #ccc;
            padding: 15px; border-radius: 8px; overflow-x: auto;
            font-family: 'Roboto Mono', monospace; font-size: 0.9rem; margin: 0;
        }

        .loader {
            width: 20px; height: 20px; border: 2px solid #fff;
            border-top-color: transparent; border-radius: 50%;
            animation: spin 1s linear infinite; display: none;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .hidden { display: none; }
        .error-msg {
            color: #d93025; background: #fce8e6; padding: 10px; border-radius: 8px;
            font-size: 0.9rem; margin-top: 10px; display: none;
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>
            <span class="material-icons-round" style="color:var(--primary);">code</span>
            C-Lang Practice AI
        </h1>
        <div class="subtitle">æƒ…å ±å‡¦ç†II è¬›ç¾©å¯¾å¿œãƒ»æ¼”ç¿’ã‚·ã‚¹ãƒ†ãƒ </div>
    </header>

    <div class="card">
        <div class="form-group" style="margin-bottom: 20px;">
            <label>API Key <a href="help.html" target="_blank" class="api-link">å–å¾—æ–¹æ³•</a></label>
            <input type="password" id="apiKey" placeholder="Alza... (Google Gemini API Key)">
        </div>

        <div class="form-row">
            <div class="form-group">
                <label>å­¦ç¿’å˜å…ƒ (è¬›ç¾©ç¯„å›²)</label>
                <select id="genre">
                    <option value="topic1">1. ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®åŸºç¤ (å¤‰æ•°, è¨ˆç®—, å…¥å‡ºåŠ›)</option>
                    <option value="topic2">2. æ¡ä»¶åˆ†å² (if, switch)</option>
                    <option value="topic3">3. ç¹°ã‚Šè¿”ã— (while, for, do-while)</option>
                    <option value="topic4">4. é–¢æ•° (å®šç¾©, å¼•æ•°, æˆ»ã‚Šå€¤)</option>
                    <option value="topic5">5. å†å¸°é–¢æ•° (éšä¹—, ãƒ•ã‚£ãƒœãƒŠãƒƒãƒ)</option>
                    <option value="topic6">6. é…åˆ— (1æ¬¡å…ƒãƒ»2æ¬¡å…ƒ, ã‚½ãƒ¼ãƒˆ)</option>
                    <option value="topic7">7. æ–‡å­—ã¨æ–‡å­—åˆ— (charé…åˆ—, ASCII)</option>
                    <option value="topic8">8. ãƒã‚¤ãƒ³ã‚¿ (ã‚¢ãƒ‰ãƒ¬ã‚¹, å‚ç…§æ¸¡ã—)</option>
                </select>
            </div>
            <div class="form-group">
                <label>é›£æ˜“åº¦</label>
                <select id="difficulty">
                    <option value="åŸºç¤">ğŸ”° åŸºç¤ (æ–‡æ³•ç¢ºèª)</option>
                    <option value="æ¨™æº–">ğŸ’» æ¨™æº– (æˆæ¥­ã®æ¼”ç¿’ãƒ¬ãƒ™ãƒ«)</option>
                    <option value="å¿œç”¨">ğŸ”¥ å¿œç”¨ (ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ å¿œç”¨)</option>
                </select>
            </div>
        </div>

        <button id="btn-start" class="btn btn-primary" onclick="generateProblem()">
            <span>å•é¡Œã‚’ä½œæˆã™ã‚‹</span>
            <div class="loader" id="loader-start"></div>
        </button>
        <div id="errorMsg" class="error-msg"></div>
    </div>

    <div id="exercise-section" class="hidden">
        <div class="card">
            <div id="question-area">
                <span class="q-label">QUESTION</span>
                <div id="q-title" class="q-text"></div>
                <div id="q-desc" class="q-desc"></div>
            </div>

            <div class="editor-wrapper">
                <div class="editor-header">
                    <span>main.c</span>
                    <a href="https://paiza.io/ja/languages/c" target="_blank" class="run-link">
                        <span class="material-icons-round" style="font-size:14px;">open_in_new</span>
                        ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§å®Ÿè¡Œç¢ºèª (Paiza.IO)
                    </a>
                </div>
                <textarea id="code-editor" spellcheck="false">
#include <stdio.h>

int main(void) {
    // ã“ã“ã«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ãã ã•ã„
    
    return 0;
}</textarea>
            </div>

            <button id="btn-submit" class="btn btn-accent" onclick="submitCode()">
                <span>æå‡ºã—ã¦æ¡ç‚¹</span>
                <div class="loader" id="loader-submit"></div>
            </button>
        </div>
    </div>

    <div id="result-area" class="card">
        <div class="score-box">
            <div class="score-label">SCORE</div>
            <div id="res-score" class="score-num">--</div>
        </div>

        <div class="feedback-card">
            <div class="fb-title">
                <span class="material-icons-round" style="color:#fbbc04;">lightbulb</span> 
                AIã‹ã‚‰ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹
            </div>
            <div id="res-feedback" style="line-height:1.7; white-space: pre-wrap;"></div>
        </div>

        <div class="feedback-card">
            <div class="fb-title">
                <span class="material-icons-round" style="color:#34a853;">code</span> 
                æ¨¡ç¯„è§£ç­”ä¾‹
            </div>
            <div id="res-model-code"></div>
        </div>
    </div>
</div>

<script>
    // --- è¬›ç¾©ãƒ»æ¼”ç¿’PDFã‹ã‚‰æŠ½å‡ºã—ãŸã€Œå­¦ç¿’ç¯„å›²ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±ã€ ---
    const courseContext = {
        "topic1": `
            ã€å˜å…ƒ1: å¤‰æ•°ã¨è¨ˆç®—ã€‘(èª²é¡Œ2 ç¯„å›²)
            - å¿…é ˆè¦ç´ : int, float, printf, scanf, å››å‰‡æ¼”ç®—, å‰°ä½™(%)
            - æ¼”ç¿’å‚¾å‘: æ•´æ•°ã®ç·å’Œã€ç©ã€çµ¶å¯¾å€¤ã€3æ¡ã®æ•´æ•°ã®æ¡åˆ†è§£ã€ä¸‰è§’å½¢ã®æˆç«‹æ¡ä»¶ã€‚
            - æ³¨æ„ç‚¹: æ•´æ•°åŒå£«ã®å‰²ã‚Šç®—ã¯åˆ‡ã‚Šæ¨ã¦ã€‚scanfã«ã¯&ãŒå¿…è¦ã€‚
        `,
        "topic2": `
            ã€å˜å…ƒ2: æ¡ä»¶åˆ†å²ã€‘(èª²é¡Œ2 ç¯„å›²)
            - å¿…é ˆè¦ç´ : if, else if, else, switch, case, break
            - æ¼”ç¿’å‚¾å‘: æ­£è² ã®åˆ¤å®šã€è§£ã®å€‹æ•°(2æ¬¡æ–¹ç¨‹å¼)ã€æœˆã®è‹±èªåè¡¨ç¤º(switch)ã€‚
            - æ³¨æ„ç‚¹: switchæ–‡ã®breakå¿˜ã‚Œã€‚ãƒ–ãƒ­ãƒƒã‚¯{}ã®ç¯„å›²ã€‚
        `,
        "topic3": `
            ã€å˜å…ƒ3: ç¹°ã‚Šè¿”ã—ã€‘(èª²é¡Œ2 ç¯„å›²)
            - å¿…é ˆè¦ç´ : for, while, do-while
            - æ¼”ç¿’å‚¾å‘: 1ã‹ã‚‰Nã¾ã§ã®å’Œ(Î£), éšä¹—è¨ˆç®—, ä¹ä¹ã®è¡¨, æœ€å¤§å…¬ç´„æ•°, å…¥åŠ›å€¤ãƒã‚§ãƒƒã‚¯(è² ãªã‚‰å†å…¥åŠ›)ã€‚
            - æ³¨æ„ç‚¹: ç„¡é™ãƒ«ãƒ¼ãƒ—å›é¿ã€‚forã¨whileã®æ›¸ãæ›ãˆã€‚
        `,
        "topic4": `
            ã€å˜å…ƒ4: é–¢æ•°ã€‘(èª²é¡Œ3 ç¯„å›²)
            - å¿…é ˆè¦ç´ : é–¢æ•°å®šç¾©, å¼•æ•°, æˆ»ã‚Šå€¤, ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—å®£è¨€
            - æ¼”ç¿’å‚¾å‘: éšä¹—(kaijo), çµ„ã¿åˆã‚ã›(combination nCr), ç´¯ä¹—(pow), ä¸‰è§’é–¢æ•°è¿‘ä¼¼(ãƒ†ãƒ¼ãƒ©ãƒ¼å±•é–‹)ã€‚
            - æ³¨æ„ç‚¹: mainé–¢æ•°ã‚ˆã‚Šå‰ã§å®£è¨€ã™ã‚‹ã‹ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—å®£è¨€ãŒå¿…è¦ã€‚å€¤æ¸¡ã—(Call by Value)ã€‚
        `,
        "topic5": `
            ã€å˜å…ƒ5: å†å¸°é–¢æ•°ã€‘(èª²é¡Œ4 ç¯„å›²)
            - å¿…é ˆè¦ç´ : å†å¸°å‘¼ã³å‡ºã—, çµ‚äº†æ¡ä»¶(ãƒ™ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹)
            - æ¼”ç¿’å‚¾å‘: éšä¹—(recursive_kaijo), ãƒ•ã‚£ãƒœãƒŠãƒƒãƒæ•°åˆ—, ãƒãƒã‚¤ã®å¡”, ãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰ã®äº’é™¤æ³•ã€‚
            - æ³¨æ„ç‚¹: çµ‚äº†æ¡ä»¶ãŒãªã„ã¨ã‚¹ã‚¿ãƒƒã‚¯ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã«ãªã‚‹ã€‚
        `,
        "topic6": `
            ã€å˜å…ƒ6: é…åˆ—ã€‘(èª²é¡Œ5, 6 ç¯„å›²)
            - å¿…é ˆè¦ç´ : é…åˆ—å®£è¨€(int a[10]), 2æ¬¡å…ƒé…åˆ—, ã‚½ãƒ¼ãƒˆ(ä¸¦ã¹æ›¿ãˆ)
            - æ¼”ç¿’å‚¾å‘: æœ€å¤§ãƒ»æœ€å°ãƒ»å¹³å‡ã®ç®—å‡º, é€†é †è¡¨ç¤º, ãƒãƒ–ãƒ«ã‚½ãƒ¼ãƒˆçš„ãªä¸¦ã¹æ›¿ãˆ, è¡Œåˆ—ã®å’Œãƒ»ç©ã€‚
            - æ³¨æ„ç‚¹: é…åˆ—ã®æ·»å­—ã¯0ã‹ã‚‰ã€‚ç¯„å›²å¤–ã‚¢ã‚¯ã‚»ã‚¹ç¦æ­¢ã€‚
        `,
        "topic7": `
            ã€å˜å…ƒ7: æ–‡å­—ã¨æ–‡å­—åˆ—ã€‘(èª²é¡Œ8 ç¯„å›²)
            - å¿…é ˆè¦ç´ : charé…åˆ—, æ–‡å­—åˆ—(çµ‚ç«¯æ–‡å­—'\0'), string.h(strlen, strcpy, strcmp)
            - æ¼”ç¿’å‚¾å‘: å›æ–‡åˆ¤å®š, æ–‡å­—åˆ—ã®é€£çµ, ç‰¹å®šæ–‡å­—ã®æ¤œç´¢, å¤§æ–‡å­—å°æ–‡å­—å¤‰æ›ã€‚
            - æ³¨æ„ç‚¹: scanf("%s", s)ã«ã¯&ã‚’ã¤ã‘ãªã„ã€‚æ–‡å­—åˆ—ã®æ¯”è¼ƒã¯==ã§ãªãstrcmpã€‚
        `,
        "topic8": `
            ã€å˜å…ƒ8: ãƒã‚¤ãƒ³ã‚¿ã€‘(èª²é¡Œ9, 10 ç¯„å›²)
            - å¿…é ˆè¦ç´ : ã‚¢ãƒ‰ãƒ¬ã‚¹(&), ãƒã‚¤ãƒ³ã‚¿å¤‰æ•°(*p), é–“æ¥å‚ç…§(*), å‚ç…§æ¸¡ã—
            - æ¼”ç¿’å‚¾å‘: å¤‰æ•°ã®å€¤ã‚’å…¥ã‚Œæ›¿ãˆã‚‹(swap), é…åˆ—ã‚’ãƒã‚¤ãƒ³ã‚¿ã§æ“ä½œ, é–¢æ•°ã«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ¸¡ã—ã¦å€¤ã‚’å¤‰æ›´ã—ã¦ã‚‚ã‚‰ã†(æœ€å¤§ãƒ»æœ€å°ã‚’åŒæ™‚ã«æ±‚ã‚ã‚‹ãªã©)ã€‚
            - æ³¨æ„ç‚¹: ãƒã‚¤ãƒ³ã‚¿ã®å‹ã¨å¤‰æ•°ã®å‹ã‚’åˆã‚ã›ã‚‹ã€‚åˆæœŸåŒ–ã—ã¦ã„ãªã„ãƒã‚¤ãƒ³ã‚¿ã®ä½¿ç”¨ç¦æ­¢ã€‚
        `
    };

    // --- 1. Model Selection Logic ---
    async function findWorkingModel(apiKey) {
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);
            
            const models = data.models || [];
            // Flash -> Pro -> ãã®ä»– ã®é †ã§å„ªå…ˆ
            const validModel = models.find(m => m.name.includes("flash")) 
                            || models.find(m => m.name.includes("pro"))
                            || models.find(m => m.supportedGenerationMethods.includes("generateContent"));
            
            if (!validModel) throw new Error("åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            return validModel.name.replace('models/', '');
        } catch (e) {
            return "gemini-1.5-flash"; // Fallback
        }
    }

    // --- 2. Generate Problem ---
    async function generateProblem() {
        const apiKey = document.getElementById('apiKey').value.trim();
        const genreKey = document.getElementById('genre').value;
        const diff = document.getElementById('difficulty').value;
        const errBox = document.getElementById('errorMsg');

        if (!apiKey) {
            errBox.style.display = 'block';
            errBox.innerText = "APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„";
            return;
        }
        errBox.style.display = 'none';

        uiState('loading-start');

        try {
            const model = await findWorkingModel(apiKey);
            const contextInfo = courseContext[genreKey];

            const prompt = `
ã‚ãªãŸã¯å¤§å­¦ã®ã€Œæƒ…å ±å‡¦ç†II (Cè¨€èª)ã€ã®æ¼”ç¿’ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚
ä»¥ä¸‹ã®è¬›ç¾©ãƒ»æ¼”ç¿’ç¯„å›²ã«åŸºã¥ã„ã¦ã€å­¦ç”Ÿå‘ã‘ã®æ¼”ç¿’å•é¡Œã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

ã€å­¦ç¿’ç¯„å›²æƒ…å ±ã€‘
${contextInfo}

ã€é›£æ˜“åº¦ã€‘
${diff}

ã€å‡ºåŠ›ãƒ«ãƒ¼ãƒ«ã€‘
ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆMarkdownè¨˜æ³•ã¯ä¸è¦ï¼‰ã€‚
{
  "title": "å•é¡Œã®ã‚¿ã‚¤ãƒˆãƒ«",
  "description": "å•é¡Œæ–‡ã€‚ä½•ã‚’å®Ÿè£…ã™ã¹ãã‹å…·ä½“çš„ã«ã€‚å…¥åŠ›ä¾‹ã¨å‡ºåŠ›ä¾‹ã‚‚å«ã‚ã¦ãã ã•ã„ã€‚",
  "template": "åˆæœŸã‚³ãƒ¼ãƒ‰ï¼ˆ#include <stdio.h> int main(void){ ... } ç¨‹åº¦ã€‚å¿…è¦ãªã‚‰é–¢æ•°ã®æ çµ„ã¿ã ã‘æ›¸ãï¼‰"
}`;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            
            if(!res.ok) throw new Error("API Request Failed");

            const data = await res.json();
            const text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
            const json = JSON.parse(text);

            // UIåæ˜ 
            document.getElementById('q-title').innerText = json.title;
            document.getElementById('q-desc').innerText = json.description;
            if(json.template) document.getElementById('code-editor').value = json.template;
            
            // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('exercise-section').style.display = 'block';
            document.getElementById('question-area').style.display = 'block';
            document.getElementById('result-area').style.display = 'none';
            document.getElementById('exercise-section').scrollIntoView({ behavior: 'smooth' });

        } catch (e) {
            errBox.style.display = 'block';
            errBox.innerText = "ã‚¨ãƒ©ãƒ¼: " + e.message + "\nAPIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
        } finally {
            uiState('idle-start');
        }
    }

    // --- 3. Submit & Grade ---
    async function submitCode() {
        const apiKey = document.getElementById('apiKey').value.trim();
        const genreKey = document.getElementById('genre').value;
        const problemTitle = document.getElementById('q-title').innerText;
        const problemDesc = document.getElementById('q-desc').innerText;
        const userCode = document.getElementById('code-editor').value;
        const errBox = document.getElementById('errorMsg');

        if (!userCode) { alert("ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

        uiState('loading-submit');

        try {
            const model = await findWorkingModel(apiKey);
            const contextInfo = courseContext[genreKey];

            const prompt = `
ã‚ãªãŸã¯Cè¨€èªã®æ¡ç‚¹å®˜ã§ã™ã€‚
ä»¥ä¸‹ã®å•é¡Œã«å¯¾ã™ã‚‹å­¦ç”Ÿã®ã‚³ãƒ¼ãƒ‰ã‚’è©•ä¾¡ãƒ»æ·»å‰Šã—ã¦ãã ã•ã„ã€‚

ã€è¬›ç¾©ã®å‰æçŸ¥è­˜ã€‘
${contextInfo}

ã€å•é¡Œã€‘
${problemTitle}
${problemDesc}

ã€æå‡ºã‚³ãƒ¼ãƒ‰ã€‘
${userCode}

ã€æ¡ç‚¹åŸºæº–ã€‘
1. ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ï¼ˆCè¨€èªã¨ã—ã¦æ­£ã—ã„ã‹ï¼‰
2. è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹ã‹
3. è¬›ç¾©ã®ç¯„å›²ã«é©ã—ãŸæ›¸ãæ–¹ã‹ï¼ˆã¾ã ç¿’ã£ã¦ã„ãªã„é«˜åº¦ãªæ©Ÿèƒ½ã‚’ä½¿ã£ã¦ã„ãªã„ã‹ï¼‰

ã€å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‘
ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ï¼ˆMarkdownä¸è¦ï¼‰ã€‚
{
  "score": ç‚¹æ•°(0-100ã®æ•´æ•°),
  "feedback": "å…·ä½“çš„ãªä¿®æ­£ç‚¹ã€è‰¯ã‹ã£ãŸç‚¹ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã‚¨ãƒ©ãƒ¼ã®è§£èª¬ãªã©ï¼ˆæ—¥æœ¬èªã§ï¼‰",
  "corrected_code": "æ¨¡ç¯„è§£ç­”ã¾ãŸã¯ä¿®æ­£å¾Œã®ã‚³ãƒ¼ãƒ‰ï¼ˆCè¨€èªï¼‰"
}`;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            if(!res.ok) throw new Error("API Request Failed");

            const data = await res.json();
            const text = data.candidates[0].content.parts[0].text.replace(/```json|```/g, '').trim();
            const json = JSON.parse(text);

            // çµæœè¡¨ç¤º
            document.getElementById('res-score').innerText = json.score;
            document.getElementById('res-feedback').innerText = json.feedback;
            
            // ã‚³ãƒ¼ãƒ‰ãƒã‚¤ãƒ©ã‚¤ãƒˆé¢¨è¡¨ç¤ºï¼ˆHTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†ï¼‰
            const escapedCode = json.corrected_code
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
            document.getElementById('res-model-code').innerHTML = `<pre>${escapedCode}</pre>`;

            document.getElementById('result-area').style.display = 'block';
            document.getElementById('result-area').scrollIntoView({ behavior: 'smooth' });

        } catch (e) {
            errBox.style.display = 'block';
            errBox.innerText = "æ¡ç‚¹ã‚¨ãƒ©ãƒ¼: " + e.message;
        } finally {
            uiState('idle-submit');
        }
    }

    // --- Utility: ã‚¨ãƒ‡ã‚£ã‚¿ã§Tabã‚­ãƒ¼ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ ---
    document.getElementById('code-editor').addEventListener('keydown', function(e) {
        if (e.key == 'Tab') {
            e.preventDefault();
            var start = this.selectionStart;
            var end = this.selectionEnd;
            this.value = this.value.substring(0, start) + "    " + this.value.substring(end);
            this.selectionStart = this.selectionEnd = start + 4;
        }
    });

    // --- UI State Management ---
    function uiState(state) {
        const startBtn = document.getElementById('btn-start');
        const submitBtn = document.getElementById('btn-submit');
        const lStart = document.getElementById('loader-start');
        const lSubmit = document.getElementById('loader-submit');

        if (state === 'loading-start') {
            startBtn.disabled = true;
            lStart.style.display = 'block';
        } else if (state === 'idle-start') {
            startBtn.disabled = false;
            lStart.style.display = 'none';
        } else if (state === 'loading-submit') {
            submitBtn.disabled = true;
            lSubmit.style.display = 'block';
        } else if (state === 'idle-submit') {
            submitBtn.disabled = false;
            lSubmit.style.display = 'none';
        }
    }
</script>

</body>
</html>
